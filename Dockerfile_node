FROM ubuntu:16.04
MAINTAINER zerogvt

ARG user_name=jenkins
ARG user_pass=jenkins
ARG slave_name
ARG jenkins_host_port

RUN apt-get -y update && \
    apt-get -y install default-jre && \
    apt-get -y install ssh && \
    apt-get -y install sudo && \
    useradd -ms /bin/bash ${user_name} && \
    echo "${user_name}:${user_pass}" | chpasswd && \
    adduser ${user_name} sudo && \
    echo "${user_name} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
USER ${user_name}
WORKDIR /home/${user_name}
RUN echo ${slave_name} > my.name && echo "localhost:${jenkins_host_port}" > my.jenkins
# expose 22 so we can ssh in
EXPOSE 22
#wait for jenkins machine to warm up - then connect
CMD sleep 5 && java -jar shared-data/remoting-3.18.jar -jnlpUrl http://$(cat my.jenkins)/computer/$(cat my.name)/slave-agent.jnlp -workDir "/home/jenkins"
#sudo service ssh start && /bin/bash
